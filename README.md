# Сервис управления библиотекой - Booker

## Функциональность

Сервис является **мастер-системой для библиотеки**.<br/>
Сервис отвечает за:
1. **Управление каталогом**
    - Хранение и предоставление данных о:
        - Книгах
            - Отображение подробной информации о книге
            - Полнотекстовый поиск книг по названию или автору
            - Фильтрация книг по жанрам
            - Добавление новых книг (_только для администратора_)
        - Авторах
            - Отображение подробной информации об авторе
            - Полнотекстовый поиск авторов по имени
            - Добавление новых авторов (_только для администратора_)
        - Жанрах
            - Добавление новых авторов (_только для администратора_)
        - Пользовательских рецензиях и оценках
            - Отображение списка комментариев под книгой
            - Добавление отзыва на книгу (_только для зарегистрированных пользователей_)

2. **Бронирование и аренда**
    - Полный цикл управления бронированием:
        - Резервирование экземпляров (_только для зарегистрированных пользователей_)
        - Отмена брони (_только для зарегистрированных пользователей_)
        - Назначение сроков брони
        - Снятие просроченных бронирований
        - Отправка нотификаций о бронировании
    - Полный цикл управления аредной:
        - Выдача книги в аренду (_только для администратора_)
        - Назначение сроков аренды
        - Окончание процесса аренды (_только для администратора_)
        - Отправка нотификаций о подходящем конце аренды и о просроченном сроке аренды
    - Предоставление информации о бронированиях и арендах
    - Хранение истории чтения пользователей

## Технологический стек

### Основные технологии
- **Язык программирования**: Kotlin (JDK 21)
- **Фреймворк**: Spring Boot 3.5

### Используемые модули Spring Boot
- Spring Data JDBC
- Spring Web
- Spring AOP
- Spring Actuator

### Вспомогательные технологии
1. **PostgreSQL** - хранение данных библиотеки
2. **Qdrant** - хранение векторного представления книг для полнотекстового поиска
3. **Ollama** - преобразование текста в вектора (эмбединг)
4. **Apache Kafka** - асинхронная отправка событий
5. **Yandex S3** - хранение изображений книг и авторов

## Интеграции

Сервис взаимодействует со следующими внутренними системами:
- gRPC запросы к **Gandalf**, для валидации пользовательского JWT токена
- Отправка сообщений в Apache Kafka в сервис **Okarun** для дальнейшей отправки электронного письма
- REST запросы в **Rohan** для генерации отчетности и получения ссылки на электронные книги

## Инструкция для запуска

Все необходимые для запуска сервиса технологии запускаются с помощью Docker Compose: `compose.yml`.
Для системы есть 2 процесса запуска: **локальный запуск** и **запуск в docker-контейнере**.

### Обязательны шаг для запуска

Для хранения изображений используется Yandex S3, бакеты S3 разворачиваются в Yandex Cloud.
Перед запуском нужно создать сервисный аккаунт в Yandex Cloud и создать 2 бакета для изображений книг и авторов. Ниже указана конфигурация Yandex S3 в файле `src/main/resources/application.yml`, на место `text` нужно указать свою информацию.

```yaml
cloud:
  aws:
    credentials:
      access-key: text
      secret-key: text
    endpoint: text
    bucket-name:
      book: books-images
      author: author-images
```

### Локальный запуск

Для локального запуска достаточно запустить Docker Compose и локально поднять приложение (самый простой способ - встроенный запуск в Intellij IDEA).
Перед запуском нужно закомментировать сервис `app`, т.к. он будет поднят не в Docker-контейнере.

### Запуск в Docker

Перед запуском сервиса в Docker, нужно настроить конфигурацию. Для этого необходимо выполнить следующие шаги:
1. Создать конфигурационный файл `src/main/resources/application-prod.yml`
2. Добавить в `application-prod.yml` чувствительные данные: пароли, ключи API хосты и порты для внешних систем (для систем, запускаемых в Docker, должны использоваться порт внутри сети Docker и имя сервиса в Docker Compose).
3. Собрать приложение
```bash
./gradlew build
```
4. Перенести собранный JAR-файл в корневую директорию на один уровень с Compose-файлом.
5. Запустить Docker Compose
```bash
docker compose up -d
```
6. После запуска сервиса вызвать команду `POST http://{hostname}:8081/api/v1/management/export` с хедером `X-MANAGEMENT-API`, указанным в конфигурации.

## Контакты
- **Разработчик**: Устинов Максим Павлович
- **Учебное заведение**: РТУ МИРЭА
- **Группа**: ИКБО-16-22
- **Год разработки**: 2025